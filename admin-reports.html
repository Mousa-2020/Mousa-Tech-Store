<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± - Mousa Tech Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: #f1f5f9;
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: #0A0F1F;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 25px 0;
        }

        .logo-area {
            padding: 0 25px 25px;
            border-bottom: 1px solid #334155;
        }

        .logo-area h2 {
            color: #F97316;
        }

        .menu-item {
            padding: 12px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #cbd5e1;
            cursor: pointer;
        }

        .menu-item:hover {
            background: #1e293b;
            color: #F97316;
        }

        .menu-item.active {
            background: #F97316;
            color: white;
        }

        .main-content {
            margin-right: 280px;
            padding: 25px;
            width: calc(100% - 280px);
        }

        .page-header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .page-header h1 {
            color: #0A0F1F;
            margin-bottom: 10px;
        }

        .date-picker {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            outline: none;
        }

        .generate-btn {
            background: #F97316;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            color: #F97316;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        canvas {
            width: 100% !important;
            height: 250px !important;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .table-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #0A0F1F;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #0A0F1F;
            color: white;
            padding: 10px;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .export-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-pdf {
            background: #EF4444;
            color: white;
        }

        .btn-excel {
            background: #10B981;
            color: white;
        }

        .btn-print {
            background: #0A0F1F;
            color: white;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .sidebar span {
                display: none;
            }
            .main-content {
                margin-right: 70px;
            }
            .summary-cards,
            .charts-grid,
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo-area">
            <h2>Mousa Tech</h2>
            <small>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</small>
        </div>
        <div class="menu-item" onclick="window.location.href='admin-dashboard.html'">ğŸ“Š Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="menu-item" onclick="window.location.href='admin-products.html'">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
        <div class="menu-item" onclick="window.location.href='admin-orders.html'">ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        <div class="menu-item" onclick="window.location.href='admin-customers.html'">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="menu-item active">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h1>ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
            <div class="date-picker">
                <input type="date" class="date-input" id="startDate">
                <input type="date" class="date-input" id="endDate">
                <button class="generate-btn" onclick="generateReport()">
                    <i class="fas fa-chart-line"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
            </div>
        </div>

        <div class="summary-cards" id="summaryCards"></div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3 style="margin-bottom: 15px;">ğŸ“Š Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                <canvas id="dailySalesChart"></canvas>
            </div>
            <div class="chart-card">
                <h3 style="margin-bottom: 15px;">ğŸ† Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>

        <div class="tables-grid">
            <div class="data-table">
                <h3 class="table-title">ğŸ“¦ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
                <table id="topProductsTable">
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                        <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
                    </tr>
                </table>
            </div>
            <div class="data-table">
                <h3 class="table-title">ğŸ“ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø·Ù„Ø¨Ø§Ù‹</h3>
                <table id="topGovernoratesTable">
                    <tr>
                        <th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                        <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
                    </tr>
                </table>
            </div>
        </div>

        <div class="export-buttons">
            <button class="export-btn btn-pdf" onclick="exportPDF()">
                <i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± PDF
            </button>
            <button class="export-btn btn-excel" onclick="exportExcel()">
                <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
            </button>
            <button class="export-btn btn-print" onclick="window.print()">
                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>
    </div>

    <script>
        const orders = JSON.parse(localStorage.getItem('orders')) || [];
        let dailySalesChart, topProductsChart;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        function initCharts() {
            const ctx1 = document.getElementById('dailySalesChart').getContext('2d');
            dailySalesChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ($)',
                        data: [],
                        backgroundColor: '#F97316'
                    }]
                },
                options: { responsive: true }
            });

            const ctx2 = document.getElementById('topProductsChart').getContext('2d');
            topProductsChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#F97316', '#0A0F1F', '#64748b', '#10B981', '#EF4444']
                    }]
                },
                options: { responsive: true }
            });
        }

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        function generateReport() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            let filteredOrders = orders;
            
            if (start && end) {
                filteredOrders = orders.filter(o => {
                    const orderDate = new Date(o.date.split(' ')[0]);
                    return orderDate >= new Date(start) && orderDate <= new Date(end);
                });
            }

            updateSummary(filteredOrders);
            updateDailySales(filteredOrders);
            updateTopProducts(filteredOrders);
            updateTopGovernorates(filteredOrders);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateSummary(orders) {
            const total = orders.length;
            const revenue = orders.reduce((s, o) => s + (o.total || 0), 0);
            const avgOrder = total ? revenue / total : 0;
            const customers = new Set(orders.map(o => o.customer?.phone)).size;

            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <div class="summary-number">${total}</div>
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">$${revenue}</div>
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">$${avgOrder.toFixed(0)}</div>
                    <div>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${customers}</div>
                    <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
            `;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        function updateDailySales(orders) {
            const daily = {};
            
            orders.forEach(order => {
                const date = order.date.split(' ')[0];
                daily[date] = (daily[date] || 0) + (order.total || 0);
            });

            const sorted = Object.entries(daily).sort().slice(-7);
            
            dailySalesChart.data.labels = sorted.map(([date]) => date);
            dailySalesChart.data.datasets[0].data = sorted.map(([, amount]) => amount);
            dailySalesChart.update();
        }

        // ØªØ­Ø¯ÙŠØ« Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹
        function updateTopProducts(orders) {
            const products = {};
            
            orders.forEach(order => {
                order.items?.forEach(item => {
                    products[item.name] = (products[item.name] || 0) + 1;
                });
            });

            const sorted = Object.entries(products)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            topProductsChart.data.labels = sorted.map(([name]) => name);
            topProductsChart.data.datasets[0].data = sorted.map(([, count]) => count);
            topProductsChart.update();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const table = document.getElementById('topProductsTable');
            sorted.forEach(([name, count]) => {
                const revenue = orders
                    .filter(o => o.items?.some(i => i.name === name))
                    .reduce((s, o) => s + (o.total || 0), 0);
                
                table.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${count}</td>
                        <td>$${revenue}</td>
                    </tr>
                `;
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
        function updateTopGovernorates(orders) {
            const govs = {};
            
            orders.forEach(order => {
                const gov = order.customer?.gov || 'Ø£Ø®Ø±Ù‰';
                govs[gov] = (govs[gov] || 0) + 1;
            });

            const sorted = Object.entries(govs)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const table = document.getElementById('topGovernoratesTable');
            sorted.forEach(([gov, count]) => {
                const revenue = orders
                    .filter(o => o.customer?.gov === gov)
                    .reduce((s, o) => s + (o.total || 0), 0);
                
                table.innerHTML += `
                    <tr>
                        <td>${gov}</td>
                        <td>${count}</td>
                        <td>$${revenue}</td>
                    </tr>
                `;
            });
        }

        // ØªØµØ¯ÙŠØ± PDF
        function exportPDF() {
            window.print();
        }

        // ØªØµØ¯ÙŠØ± Excel
        function exportExcel() {
            let csv = "Ø§Ù„ØªÙ‚Ø±ÙŠØ±,Ø§Ù„Ù‚ÙŠÙ…Ø©\n";
            csv += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª,${orders.length}\n`;
            csv += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª,${orders.reduce((s,o)=>s+(o.total||0),0)}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.csv';
            a.click();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
        initCharts();
        generateReport();
    </script>
</body>
</html>
