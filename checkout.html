<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ - Mousa Tech Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .checkout-page { padding: 20px 0 80px; }
        .checkout-title { font-size: 1.8rem; color: #0A0F1F; margin-bottom: 25px; }
        .checkout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .section-card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .section-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; color: #0A0F1F; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-input, .form-select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; }
        .payment-option { display: flex; align-items: center; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
        .payment-option.selected { border-color: #F97316; background: rgba(249,115,22,0.05); }
        .payment-option input { display: none; }
        .payment-icon { width: 40px; height: 40px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-left: 15px; }
        .order-summary { background: white; border-radius: 15px; padding: 25px; position: sticky; top: 100px; }
        .order-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .order-total { display: flex; justify-content: space-between; padding: 20px 0; border-top: 2px solid #e2e8f0; font-size: 1.3rem; font-weight: 700; }
        .submit-order { width: 100%; background: #F97316; color: white; border: none; padding: 18px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; margin-top: 20px; }
        .invoice-preview { margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 2px dashed #F97316; display: none; }
        .invoice-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .invoice-table th { background: #0A0F1F; color: white; padding: 10px; }
        .invoice-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
        .invoice-actions { display: flex; gap: 10px; margin-top: 20px; }
        .invoice-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
        .invoice-btn.pdf { background: #EF4444; color: white; }
        .invoice-btn.whatsapp { background: #25D366; color: white; }
        @media (max-width: 768px) { .checkout-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html"><img src="logo.png" alt="Mousa Tech Store" class="logo"></a>
            <div class="header-buttons">
                <button class="icon-btn" onclick="window.location.href='cart.html'">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container checkout-page">
        <h1 class="checkout-title">âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h1>

        <div class="checkout-grid">
            <div>
                <div class="section-card">
                    <h2 class="section-title">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
                    <div class="form-group"><input type="text" class="form-input" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"></div>
                    <div class="form-group"><input type="tel" class="form-input" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"></div>
                    <div class="form-group">
                        <select class="form-select" id="governorate" onchange="updateDelivery()">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                            <option value="Ø¨ØºØ¯Ø§Ø¯">Ø¨ØºØ¯Ø§Ø¯</option>
                            <option value="Ø§Ù„Ø¨ØµØ±Ø©">Ø§Ù„Ø¨ØµØ±Ø©</option>
                            <option value="Ø£Ø±Ø¨ÙŠÙ„">Ø£Ø±Ø¨ÙŠÙ„</option>
                            <option value="Ø§Ù„Ù…ÙˆØµÙ„">Ø§Ù„Ù…ÙˆØµÙ„</option>
                        </select>
                    </div>
                    <div class="form-group"><input type="text" class="form-input" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„"></div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h2>
                    <label class="payment-option selected" onclick="selectPayment('cash')">
                        <input type="radio" name="payment" value="cash" checked hidden>
                        <div class="payment-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div>Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
                    </label>
                    <label class="payment-option" onclick="selectPayment('card')">
                        <input type="radio" name="payment" value="card" hidden>
                        <div class="payment-icon"><i class="fas fa-credit-card"></i></div>
                        <div>Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</div>
                    </label>
                </div>
            </div>

            <div>
                <div class="order-summary">
                    <h2 class="section-title">ğŸ›ï¸ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h2>
                    <div id="orderItems"></div>
                    <div class="order-total" id="orderTotal"></div>
                    
                    <div class="invoice-preview" id="invoicePreview"></div>
                    
                    <button class="submit-order" onclick="submitOrder()">
                        <i class="fas fa-check-circle"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js"></script>
    
    <script>
        // ===== Firebase Config =====
        const firebaseConfig = {
            apiKey: "AIzaSyBEk2TemPijtg6dHCd0dFLOzciXUIZCOHA",
            authDomain: "mousa-tech-store.firebaseapp.com",
            projectId: "mousa-tech-store",
            storageBucket: "mousa-tech-store.firebasestorage.app",
            messagingSenderId: "395430710427",
            appId: "1:395430710427:web:c914a92653225535010a3e",
            measurementId: "G-GX1XFLE3FP"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        console.log('âœ… Firebase initialized');

        // ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª =====
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let deliveryCost = 0;
        let selectedPayment = 'cash';

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
        function displayOrderSummary() {
            const itemsDiv = document.getElementById('orderItems');
            const totalDiv = document.getElementById('orderTotal');
            
            if (cart.length === 0) {
                window.location.href = 'index.html';
                return;
            }

            let subtotal = 0;
            itemsDiv.innerHTML = cart.map(item => {
                subtotal += Number(item.price) || 0;
                return `<div class="order-item"><span>${item.name}</span><span>$${Number(item.price).toLocaleString()}</span></div>`;
            }).join('');

            const total = subtotal + deliveryCost;
            totalDiv.innerHTML = `<span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>$${total.toLocaleString()}</span>`;
            updateCartCount();
        }

        function updateDelivery() {
            deliveryCost = document.getElementById('governorate').value === 'Ø¨ØºØ¯Ø§Ø¯' ? 5 : 10;
            displayOrderSummary();
        }

        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
        async function submitOrder() {
            console.log('âœ… Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ ØªÙ… Ø§Ù„Ø¶ØºØ·');
            
            const name = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const gov = document.getElementById('governorate').value;
            const address = document.getElementById('address').value;

            if (!name || !phone || !gov || !address) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                return;
            }

            const subtotal = cart.reduce((s, i) => s + (Number(i.price) || 0), 0);
            
            const order = {
                id: Date.now(),
                date: new Date().toLocaleString('ar-IQ'),
                customer: { name, phone, gov, address },
                items: cart.map(i => ({ name: i.name, price: Number(i.price) || 0 })),
                subtotal: subtotal,
                delivery: deliveryCost,
                total: subtotal + deliveryCost,
                payment: selectedPayment === 'cash' ? 'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
                status: 'Ø¬Ø¯ÙŠØ¯',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Ø­ÙØ¸ ÙÙŠ Firebase
                const docRef = await db.collection('orders').add(order);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase:', docRef.id);
                
                // Ø­ÙØ¸ ÙÙŠ localStorage
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                orders.push(order);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
                localStorage.removeItem('cart');
                
                alert('âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                window.location.href = `thank-you.html?id=${order.id}`;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Firebase:', error);
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹');
                localStorage.removeItem('cart');
                window.location.href = `thank-you.html?id=${order.id}`;
            }
        }

        function updateCartCount() {
            document.getElementById('cartCount').textContent = cart.length;
        }

        displayOrderSummary();
    </script>
</body>
</html>
