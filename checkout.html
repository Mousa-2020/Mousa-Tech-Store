<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ - Mousa Tech Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html"><img src="logo.png" alt="Mousa Tech Store" class="logo"></a>
            <div class="header-buttons">
                <button class="icon-btn" onclick="window.location.href='cart.html'">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container checkout-page">
        <h1 class="checkout-title">âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h1>

        <div class="checkout-grid">
            <div>
                <div class="section-card">
                    <h2 class="section-title">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
                    <div class="form-group">
                        <input type="text" class="form-input" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                    </div>
                    <div class="form-group">
                        <input type="tel" class="form-input" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="governorate">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                            <option value="Ø¨ØºØ¯Ø§Ø¯">Ø¨ØºØ¯Ø§Ø¯</option>
                            <option value="Ø§Ù„Ø¨ØµØ±Ø©">Ø§Ù„Ø¨ØµØ±Ø©</option>
                            <option value="Ø£Ø±Ø¨ÙŠÙ„">Ø£Ø±Ø¨ÙŠÙ„</option>
                            <option value="Ø§Ù„Ù…ÙˆØµÙ„">Ø§Ù„Ù…ÙˆØµÙ„</option>
                            <option value="Ø§Ù„Ù†Ø¬Ù">Ø§Ù„Ù†Ø¬Ù</option>
                            <option value="ÙƒØ±ÙƒÙˆÙƒ">ÙƒØ±ÙƒÙˆÙƒ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
                    </div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h2>
                    <label class="payment-option selected" onclick="selectPayment('cash')">
                        <input type="radio" name="payment" value="cash" checked hidden>
                        <div class="payment-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div>Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
                    </label>
                    <label class="payment-option" onclick="selectPayment('card')">
                        <input type="radio" name="payment" value="card" hidden>
                        <div class="payment-icon"><i class="fas fa-credit-card"></i></div>
                        <div>Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</div>
                    </label>
                </div>
            </div>

            <div>
                <div class="order-summary">
                    <h2 class="section-title">ğŸ›ï¸ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h2>
                    <div id="orderItems" class="order-items"></div>
                    <div class="order-total" id="orderTotal"></div>
                    <button class="submit-order" onclick="submitOrder()">
                        <i class="fas fa-check-circle"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <a href="https://wa.me/9647717538315" class="whatsapp-float" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let deliveryCost = 0;
        let selectedPayment = 'cash';

        function displayOrderSummary() {
            const itemsDiv = document.getElementById('orderItems');
            const totalDiv = document.getElementById('orderTotal');
            
            if (cart.length === 0) {
                window.location.href = 'index.html';
                return;
            }

            let subtotal = 0;
            itemsDiv.innerHTML = cart.map(item => {
                subtotal += Number(item.price) || 0;
                return `<div class="order-item">
                    <span class="order-item-name">${item.name}</span>
                    <span class="order-item-price">$${Number(item.price).toLocaleString()}</span>
                </div>`;
            }).join('');

            const total = subtotal + deliveryCost;
            totalDiv.innerHTML = `<span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>$${total.toLocaleString()}</span>`;
            updateCartCount();
        }

        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        async function submitOrder() {
            const name = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const gov = document.getElementById('governorate').value;
            const address = document.getElementById('address').value;

            if (!name || !phone || !gov || !address) {
                alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }

            const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) || 0), 0);
            
            const order = {
                id: Date.now(),
                date: new Date().toLocaleString('ar-IQ'),
                customer: { name, phone, gov, address },
                items: cart.map(item => ({ name: item.name, price: Number(item.price) || 0 })),
                subtotal: subtotal,
                delivery: deliveryCost,
                total: subtotal + deliveryCost,
                payment: selectedPayment === 'cash' ? 'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
                status: 'Ø¬Ø¯ÙŠØ¯',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Ø­ÙØ¸ ÙÙŠ Firebase
                await db.collection('orders').add(order);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase');
                
                // Ø­ÙØ¸ ÙÙŠ localStorage Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                orders.push(order);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
                localStorage.removeItem('cart');
                
                alert('âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                window.location.href = `thank-you.html?id=${order.id}`;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Firebase:', error);
                alert('âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹');
                localStorage.removeItem('cart');
                window.location.href = `thank-you.html?id=${order.id}`;
            }
        }

        function updateCartCount() {
            document.getElementById('cartCount').textContent = cart.length;
        }

        displayOrderSummary();
    </script>
</body>
</html>
